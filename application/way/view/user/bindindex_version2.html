<!DOCTYPE html>
<html>
<head>
<title>车辆绑定</title>
<meta
	http-equiv="Content-Type"
	content="text/html; charset=utf-8"
/>
<meta
	name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"
/>
<meta
	name="apple-mobile-web-app-capable"
	content="yes"
>
<meta
	name="apple-mobile-web-app-status-bar-style"
	content="black"
>
<title></title>
<link
	href="__STATIC__/way2/css/gs.css?v=1.0"
	type="text/css"
	rel="stylesheet"
/>
<link
	href="__STATIC__/way2/css/reset.css"
	type="text/css"
	rel="stylesheet"
/>
<link
	rel="stylesheet"
	href="__STATIC__/way2/css/swiper.min.css"
>
<link
	rel="stylesheet"
	type="text/css"
	href="__STATIC__/way2/css/mui.picker.min.css"
/>
<link
	rel="stylesheet"
	href="__STATIC__/way2/css/mui.min.css"
>
<script
	src="__JS__/jquery-1.8.3.min.js"
	type="text/javascript"
></script>
<script src="__STATIC__/way2/js/special.js"></script>
<script src="__STATIC__/way2/js/carry.js"></script>

<script src="__STATIC__/way2/js/swiper.min.js"></script>
<script src="__STATIC__/way2/js/mui.min.js"></script>
<script src="__STATIC__/way2/js/mui.picker.min.js"></script>
<!--<script type="text/javascript" charset="utf-8">-->
<!--mui.init();-->
<!--</script>-->

 <script src="__STATIC__/way2/js/iosOverlay.js"></script>
    <script src="__STATIC__/way2/js/spin.min.js"></script>
    <script src="__STATIC__/way2/js/prettify.js"></script>
    <script src="__STATIC__/way2/js/custom.js"></script>
 <link rel="stylesheet" href="__STATIC__/way2/css/custom.css">
    <link rel="stylesheet" href="__STATIC__/way2/css/iosOverlay.css">
    <link rel="stylesheet" href="__STATIC__/way2/css/prettify.css">
<script type="text/javascript">
function yincang(){
    $(".m111").hide();
    $(".ios-overlay-show").hide();
   	document.body.removeEventListener('touchmove',handler,false);
    document.body.removeEventListener('wheel',handler,false);
}
</script>



<script src="__JS__/angularjs.js"></script>
<script
	type="text/javascript"
	src="__JS__/jsencrypt.min.js"
></script>
<style>
        .m111{
            z-index: 999;
        }
        
        
.hide1{
	display:none;
}        
    </style>
</head>
<body>
	<form class="kscx_top" id="form_id" method="post" ng-app="myApp" ng-controller="myCtrl">
	<div class="yhbd">
		<p class="gexx">个人信息</p>
		<ul class="bd_ul">
			<li class="bd_li">姓名<input
				name="username"
				id="username"
				type="text"
				class="ws_yh"
				placeholder="请输入用户名"
			></li>
			<li class="bd_li">手机号<input
				name="phone"
				type="text"
				class="ws_yh"
				placeholder="请输入手机号"
			></li>
			<li class="bd_li">验证码 <input
				
				type="button"
				class="obtain generate_code ws_yzm"
				value="获取验证码"
				onclick="settime(this);"
			> <input
			name="yzm"
				type="text"
				class="ws_yh witdh_100"
				placeholder="请输入验证码"
			>
			</li>

			<li class="bd_li hide1">身份证号<input
				name="identity_card"
				type="text"
				class="ws_yh"
				placeholder="请输入身份证号"
			></li>

			
		</ul>
		<p class="gexx top30">车辆信息</p>
		<ul class="bd_ul">
			<li class="bd_li">车牌号<input
				name="car_number"
				type="text"
				class="ws_yh"
				placeholder="请输车牌号"
			></li>
			<li class="bd_li hide1">注册时间
				<button
				type="button" 
					id='demo2'
					data-options='{"type":"date","beginYear":1995,"endYear":2026}'
					class="btn mui-btn mui-btn-block ws_yh"
				>
				<input type="hidden" name="reg_time" value="" />
					<div
						id='result'
						class="ui-alert ws_sj1"
					>{$reg_time}</div>
				</button>
			</li>
			<li class="bd_li hide1">发动机号<input
				name="engine"
				type="text"
				class="ws_yh"
				placeholder="请输入发动机号"
			></li>
			<li class="bd_li hide1">车辆识别码<input
				name="chassis_number"
				type="text"
				class="ws_yh"
				placeholder="请输入车辆识别码"
			></li>
			<li class="bd_li hide1">车型<select
				name="car_type_id"
				class="ws_yh"
			>
					<option value="0">请选择车型</option>
						<option
							value="{{ x.uni_id }}"
							ng-selected="number123==x.uni_id"
							ng-repeat="x in names"
							ng-bind="x.name"
						></option>
			</select></li>
			<li class="bd_li hide1">品牌<input
				name="brand"
				type="text"
				class="ws_yh"
				placeholder="请输入品牌"
			></li>
			<li class="bd_li hide1">颜色<select
				name="car_color"
				class="ws_yh"
			>
					<option value="0">请选择颜色</option>
						<option
							value="{{ x.id }}"
							ng-selected="form_car_color==x.id"
							ng-repeat="x in repeat_car_color"
							ng-bind="x.value"
						></option>
			</select></li>
		</ul>
		<!--<p class="wsxx">完善车辆信息，点击下面按钮扫描证件</p>-->
		<!--<div class="scxx clearfix">-->
		<!--<p class="sczj"> <a href="#"><img src="images/scxx_tp_03.jpg">上传身份证照片</a></p>-->
		<!--<p class="sczj"> <a href="#"><img src="images/scxx_tp_03.jpg">上传行驶证照片</a></p>-->
		<!--</div>-->

		<div class="kuan1">
			<button type="button" class="xiayibu">下一步</button>
		</div>
	</div>

	<div class="tpsc">
		<p class="bqxx">补全信息</p>
		<div class="pading77">

			<div class="bg_t">
				<input
					type="file"
					name="identity_image0"
					accept="{:\\app\\common\\tool\\ConfigTool::$WAY_USER_BIND_CAR__IMAGE_MINE}"
					id="file0"
					class="scip"
				/> <img
					src="__STATIC__/{$form_array.identity_image0|str_replace='\\\\','/',###}"
					id="img0"
					class="sctp"
				>
			</div>

			<div class="bg_t"> 
				<input
					type="file"
					name="identity_image1"
					accept="{:\\app\\common\\tool\\ConfigTool::$WAY_USER_BIND_CAR__IMAGE_MINE}"
					id="file0"
					class="scip"
				/> <img
					src="__STATIC__/{$form_array.identity_image1|str_replace='\\\\','/',###}"
					id="img0"
					class="sctp"
				>
			</div>

			<div class="bg_t">
				<input
					type="file"
					name="driving_license_image0"
					accept="{:\\app\\common\\tool\\ConfigTool::$WAY_USER_BIND_CAR__IMAGE_MINE}"
					id="file0"
					class="scip"
				/> 
				<img
					src="__STATIC__/{$form_array.driving_license_image0|str_replace='\\\\','/',###}"
					id="img0"
					class="sctp"
				>
			</div>

			<div class="bg_t">
				<input
					type="file"
					accept="{:\\app\\common\\tool\\ConfigTool::$WAY_USER_BIND_CAR__IMAGE_MINE}"
					name="driving_license_image1"
					id="file0"
					class="scip"
				/> <img
					src="__STATIC__/{$form_array.driving_license_image1|str_replace='\\\\','/',###}"
					id="img0"
					class="sctp"
				>
			</div>

		</div>
		<div class="ws_dj1">
			<div class="tg_kuan">
				<label><input
					type="checkbox"
					id="yes"
					name="_agree"
				/></label><span class="s1">我已阅读并同意<span class="s2">《吉林省高速缴费平台用户缴费协议》</span></span>
			</div>
			<div class="qc clearfix">
				<div class="syb">
					<button type="button" class="ssiby">上一步</button>
				</div>
				<div class="kuan2">
				
								<input
					class="li_input_hidden"
					type="hidden"
					name="id"
					value="0"
				/>
					<button id="zhuce" class="submit ws_qq" type="submit" disabled="true" >提交</button>
				</div>
			</div>
		</div>
	</div>

	<div class="baiping">
		<div class="cgjm">
			<p class="zccc">恭喜您注册成功！！</p>
			<p class="zzsh">系统正在审核，24小时内给您回复是否绑定成功！</p>
			<ul>
				<li>姓名： 张XX</li>
				<li>车牌： 吉A HH126</li>
				<li>绑定时间： 2017年9月2日</li>
				<li>绑定状态： 审核中</li>
			</ul>
			<button type="button" class="wancheng">完成</button>
		</div>
	</div>

	<div
		id="rsa_public_key"
		style="display: none;"
	>{$rsa_public_key}</div>
	<div class="ios-overlay-show"></div>
    <div class="m111"></div>
</form>
</body>

<script type="text/javascript">
	$(".xiayibu").click(function() {
		dianji();
		$.post("{:url('way/user/checkNext')}" ,$("#form_id").serialize() , function(data){
			yincang();
			if(0 == data.errcode ){
				$(".yhbd").hide();
				$(".tpsc").show();
			}else{
				show(data.html);
			}
		} ,'json');
		
		
	});

	$(".ssiby").click(function() {
		$(".yhbd").show();
		$(".tpsc").hide();
	});

	$(".pading77 ").children("div").each(function() {
		var th = $(this);
		nothing(th);
	});

	function nothing(id) {
		//上传图片
		id.children("input[type='file']").change(function() {
			// getObjectURL是自定义的函数，见下面
			// this.files[0]代表的是选择的文件资源的第一个，因为上面写了 multiple="multiple" 就表示上传文件可能不止一个
			// ，但是这里只读取第一个
			var objUrl = getObjectURL(this.files[0]);
			// 这句代码没什么作用，删掉也可以
			// console.log("objUrl = "+objUrl) ;
			if (objUrl) {
				// 在这里修改图片的地址属性
				id.children("img").attr("src", objUrl);
			}
		});
	}

	//建立一個可存取到該file的url
	function getObjectURL(file) {
		var url = null;
		// 下面函数执行的效果是一样的，只是需要针对不同的浏览器执行不同的 js 函数而已
		if (window.createObjectURL != undefined) { // basic
			url = window.createObjectURL(file);
		} else if (window.URL != undefined) { // mozilla(firefox)
			url = window.URL.createObjectURL(file);
		} else if (window.webkitURL != undefined) { // webkit or chrome
			url = window.webkitURL.createObjectURL(file);
		}
		return url;
	}


	//显示成功界面
	function win() {
		$(".baiping").css("display", "block");
	}

	//日期
	(function($) {
		$.init();
		var result = $('#result')[0];
		var btns = $('.btn');
		jQuery("[name='reg_time']").val("{$reg_time}");
	
		btns.each(function(i, btn) {
			btn.addEventListener('tap', function() {
				var optionsJson = this.getAttribute('data-options') || '{}';
				var options = JSON.parse(optionsJson);
				var id = this.getAttribute('id');
				/*
				 * 首次显示时实例化组件
				 * 示例为了简洁，将 options 放在了按钮的 dom 上
				 * 也可以直接通过代码声明 optinos 用于实例化 DtPicker
				 */
				var picker = new $.DtPicker(options);
				picker.show(function(rs) {
					/*
					 * rs.value 拼合后的 value
					 * rs.text 拼合后的 text
					 * rs.y 年，可以通过 rs.y.vaue 和 rs.y.text 获取值和文本
					 * rs.m 月，用法同年
					 * rs.d 日，用法同年
					 * rs.h 时，用法同年
					 * rs.i 分（minutes 的第二个字母），用法同年
					 */
					result.innerText = '' + rs.text;
					jQuery("[name='reg_time']").val(rs.text);
					/*
					 * 返回 false 可以阻止选择框的关闭
					 * return false;
					 */
					/*
					 * 释放组件资源，释放后将将不能再操作组件
					 * 通常情况下，不需要示放组件，new DtPicker(options) 后，可以一直使用。
					 * 当前示例，因为内容较多，如不进行资原释放，在某些设备上会较慢。
					 * 所以每次用完便立即调用 dispose 进行释放，下次用时再创建新实例。
					 */
					picker.dispose();
				});
			}, false);
		});
	})(mui);
</script>


<script type="text/javascript">
var app = angular.module('myApp', []);
</script>

	<script>

var form_data = {$form};
if(typeof form_data.car_type_id =='undefined'){
	form_data.car_type_id =0;
}
if(typeof form_data.car_color =='undefined'){
	form_data.car_color = 0;
}

app.controller('myCtrl', function($scope,$http) {
    //$scope.form_name = "绑定车辆";
    $scope.number123 = form_data.car_type_id;
    $scope.form_car_color = form_data.car_color;
    
    $http.get('{:url('way/user/getCarTypeJson')}').success(function (response) { 
 	   $scope.names = response.records;
 	});
   
    $http.get('{:url('way/user/getCarColorJson')}').success(function (response) { 
 	   $scope.repeat_car_color = response.records;
 	});
   
});

var encrypt = new JSEncrypt();
var public_key=$("#rsa_public_key").html();

var handler = function () {
    event.preventDefault();
    event.stopPropagation();
};


encrypt.setPublicKey(public_key);
//var data = encrypt.encrypt("123456789");

function getIsUploadImage(sel_id){
	if(typeof $("[name='"+sel_id+"']")[0].files[0] == 'undefined' ){
		return encrypt.encrypt('');
	}else{
		return $("[name='"+sel_id+"']")[0].files[0];
	}
}

function hide_btn(){
	
}
function show_loading(){
    document.body.addEventListener('touchmove',handler,false);
    document.body.addEventListener('wheel',handler,false);
	dianji();
}
function hide(){
	yincang();
}
function show(html){
	mui.alert( html , function() {
		//回调函数。需要时候用
	});
}
$(function() {
	yincang();

	//$("input[name='reg_time']").datetimePicker({title:"车辆注册时间",m:1});  //年月日
	hide_btn();
	
	$("li input,.li_input_hidden").each(function(){
		if(typeof form_data[$(this).attr('name')] != 'undefined' && $(this).attr('type') != 'file' ){
			$(this).val( form_data[$(this).attr('name')] );
			if( 'car_number' == $(this).attr('name')){
				//$(this).attr("readonly","readonly");
			}
		}
	})
	
	
	var is_submit = false;
	var formData = {};
	var th_input={};
	$("#form_id").submit(function(){
		
		
		if(! $("#yes").prop("checked") ){
			show("请勾选 吉林省高速缴费平台用户缴费协议");
			return false;
		}
		
		if(is_submit){
			return false;
		}
		is_submit = true;
		
		formData = new FormData();
		
		$("#form_id").find("input,select,textarea").each(function(){
			th_input = $(this);
			if(th_input.attr("type") == "file"){
				return ;
			}
			formData.append( th_input.attr("name") , encrypt.encrypt (th_input.val() ) );
		});
		
		formData.append("identity_image0", getIsUploadImage("identity_image0") );
		formData.append("identity_image1", getIsUploadImage("identity_image1") );
		formData.append("driving_license_image0", getIsUploadImage("driving_license_image0") );
		formData.append("driving_license_image1", getIsUploadImage("driving_license_image1") );
	
		formData.append("_method" , '{$form_method}' );

		$.ajax({
			url:"{$form_url}",
			data:formData,
			dataType:"json",
			type:"POST",
			processData : false, 
			contentType : false,
			beforeSend:function(){
				show_loading();	
			},
			success:function(data){
				hide();
				if(0 === data.errcode){
					show(data.html);
					
					$(".cgjm ul li").eq(0).html("姓名："+data.data.username);
					$(".cgjm ul li").eq(1).html("车牌： "+data.data.car_number);
					$(".cgjm ul li").eq(2).html("绑定时间： "+data.data.dis_create_time);
					//$(".cgjm ul li").eq(0).html("姓名：".data.data.username);
					//$(".cgjm ul li").eq(0).html("姓名：".data.data.username);
					
					win();
					
					$(".wancheng").click(function(){
						location.href=data.view_url;
					});
				}else{
					show(data.html);
					if(data.step == 1){
						$(".yhbd").show();
						$(".tpsc").hide();
					}else{
						$(".yhbd").hide();
						$(".tpsc").show();
					}
				}
			},
			complete:function(){
				is_submit = false;
			},
			error:function(data){
				hide();
				//alert(JSON.stringify(data))
				show("系统错误请重试，或联系客服人员");
			}
		});
		
		return false;
	});
	
});

countdown=60;
var is_send_yzm = false;
function settime(val) {
    if (countdown == 0) {
        val.removeAttribute("disabled");
        val.value="获取验证码";
        countdown = 60;
        is_send_yzm = false;
        return false;
    } else {
        val.setAttribute("disabled", true);
        val.value="重新发送(" + countdown + ")";
        countdown--;
        !is_send_yzm && send_yzm();
    }
    setTimeout(function() {
        settime(val);
    },1000);
}
function send_yzm(){
	is_send_yzm = true;
	var data = {};
	data.phone = $("[name='phone']").val();
	$.post('{:url('way/user/send')}'  ,data ,function(data){
	
		if(0 == data.errcode){
			//show(data.html);
		}else{
			countdown=0;
			show(data.html);
		}
	},'json');
}
	
function wcao(){
    $(".m111").show();
}
</script>
</html>